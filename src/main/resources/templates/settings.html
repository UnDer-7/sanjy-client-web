<!DOCTYPE html>
<html xmlns:th="http://www.thymeleaf.org">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <link rel="icon" type="image/svg+xml" href="/favicon.svg">
    <title>Settings - SanJy</title>
    <link rel="stylesheet" th:href="@{/css/main.css}">
    <link rel="stylesheet" th:replace="~{fragments/header :: header-styles}">
    <style>
        .settings-container {
            max-width: 800px;
            margin: 0 auto;
        }

        .settings-section {
            background-color: var(--surface-color);
            padding: var(--spacing-xl);
            border-radius: var(--border-radius);
            box-shadow: var(--shadow-sm);
            margin-bottom: var(--spacing-lg);
        }

        .settings-section h2 {
            color: var(--primary-color);
            margin-bottom: var(--spacing-md);
            font-size: 1.25rem;
        }

        .settings-section p {
            color: var(--text-secondary);
            margin-bottom: var(--spacing-lg);
        }

        .timezone-info {
            background-color: var(--bg-color);
            padding: var(--spacing-md);
            border-radius: var(--border-radius-sm);
            margin-bottom: var(--spacing-lg);
        }

        .timezone-info-row {
            display: flex;
            justify-content: space-between;
            align-items: center;
            padding: var(--spacing-sm) 0;
            border-bottom: 1px solid var(--border-color);
        }

        .timezone-info-row:last-child {
            border-bottom: none;
        }

        .timezone-info-label {
            color: var(--text-secondary);
            font-weight: 500;
        }

        .timezone-info-value {
            color: var(--text-primary);
            font-family: monospace;
        }

        .success-message {
            background-color: #dcfce7;
            color: var(--success-color);
            padding: var(--spacing-md);
            border-radius: var(--border-radius-sm);
            margin-bottom: var(--spacing-lg);
            display: none;
        }

        .success-message.show {
            display: block;
        }
    </style>
</head>
<body>
    <div class="container">
        <div th:replace="~{fragments/header :: app-header}"></div>

        <main class="settings-container">
            <div class="settings-section">
                <h2>‚öôÔ∏è Application Settings</h2>
                <p>Configure your preferences for the SanJy application.</p>

                <div id="success-message" class="success-message">
                    Settings saved successfully!
                </div>

                <div class="form-section">
                    <h2>üåç Timezone Settings</h2>
                    <p class="help-text">
                        Select your timezone. All times in the application will be displayed in your selected timezone.
                        When you record meals or filter by time, your local time will be automatically converted to UTC for storage.
                    </p>

                    <div class="timezone-info">
                        <div class="timezone-info-row">
                            <span class="timezone-info-label">Detected Timezone:</span>
                            <span class="timezone-info-value" id="detected-timezone">Loading...</span>
                        </div>
                        <div class="timezone-info-row">
                            <span class="timezone-info-label">Current Offset:</span>
                            <span class="timezone-info-value" id="current-offset">Loading...</span>
                        </div>
                        <div class="timezone-info-row">
                            <span class="timezone-info-label">Current Time:</span>
                            <span class="timezone-info-value" id="current-time-display">Loading...</span>
                        </div>
                    </div>

                    <div class="form-group">
                        <label for="timezone-select">Select Timezone:</label>
                        <select id="timezone-select" class="form-control">
                            <option value="">-- Select Timezone --</option>
                            <option th:each="tz : ${timezones}" th:value="${tz}" th:text="${tz}"></option>
                        </select>
                    </div>

                    <div class="form-actions">
                        <button type="button" id="save-settings-btn" class="btn btn-primary">Save Settings</button>
                        <button type="button" id="reset-settings-btn" class="btn btn-secondary">Reset to Browser Default</button>
                        <a th:href="@{/}" class="btn btn-secondary">Back to Home</a>
                    </div>
                </div>
            </div>
        </main>

        <footer>
            <p>&copy; 2025 SanJy - Food Control System</p>
        </footer>
    </div>

    <script th:replace="~{fragments/header :: header-scripts}"></script>
    <script src="/js/timezone.js"></script>
    <script>
        document.addEventListener('DOMContentLoaded', function() {
            // Initialize timezone manager
            const timezoneManager = window.TimezoneManager;

            // Update detected timezone info
            const detectedTimezone = timezoneManager.getTimezone();
            document.getElementById('detected-timezone').textContent = detectedTimezone;

            // Update current offset
            const now = new Date();
            const offsetMinutes = -now.getTimezoneOffset();
            const offsetHours = Math.floor(Math.abs(offsetMinutes) / 60);
            const offsetMins = Math.abs(offsetMinutes) % 60;
            const offsetSign = offsetMinutes >= 0 ? '+' : '-';
            document.getElementById('current-offset').textContent =
                `UTC${offsetSign}${String(offsetHours).padStart(2, '0')}:${String(offsetMins).padStart(2, '0')}`;

            // Update current time
            function updateCurrentTime() {
                const now = new Date();
                document.getElementById('current-time-display').textContent =
                    now.toLocaleString('en-US', {
                        dateStyle: 'medium',
                        timeStyle: 'long',
                        timeZone: detectedTimezone
                    });
            }
            updateCurrentTime();
            setInterval(updateCurrentTime, 1000);

            // Load saved timezone and set select value
            const savedTimezone = timezoneManager.getTimezone();
            const timezoneSelect = document.getElementById('timezone-select');
            if (savedTimezone) {
                timezoneSelect.value = savedTimezone;
            }

            // Save settings button
            document.getElementById('save-settings-btn').addEventListener('click', function() {
                const selectedTimezone = timezoneSelect.value;
                if (!selectedTimezone) {
                    alert('Please select a timezone');
                    return;
                }

                timezoneManager.setTimezone(selectedTimezone);

                // Show success message
                const successMessage = document.getElementById('success-message');
                successMessage.classList.add('show');
                setTimeout(() => {
                    successMessage.classList.remove('show');
                }, 3000);

                // Update the detected timezone display
                document.getElementById('detected-timezone').textContent = selectedTimezone;
            });

            // Reset settings button
            document.getElementById('reset-settings-btn').addEventListener('click', function() {
                if (confirm('Reset timezone to browser default?')) {
                    timezoneManager.clearTimezone();
                    const browserTimezone = timezoneManager.getTimezone();
                    timezoneSelect.value = browserTimezone;
                    document.getElementById('detected-timezone').textContent = browserTimezone;

                    // Show success message
                    const successMessage = document.getElementById('success-message');
                    successMessage.textContent = 'Settings reset to browser default!';
                    successMessage.classList.add('show');
                    setTimeout(() => {
                        successMessage.textContent = 'Settings saved successfully!';
                        successMessage.classList.remove('show');
                    }, 3000);
                }
            });
        });
    </script>
</body>
</html>
