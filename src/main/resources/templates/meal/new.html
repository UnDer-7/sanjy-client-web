<!DOCTYPE html>
<html xmlns:th="http://www.thymeleaf.org">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <link rel="icon" type="image/svg+xml" href="/favicon.svg">
    <title>Record Meal - SanJy</title>
    <link rel="stylesheet" th:href="@{/css/main.css}">
    <link rel="stylesheet" th:href="@{/css/meal.css}">
</head>
<body>
    <div class="container">
        <header>
            <h1>Record Meal</h1>
            <nav>
                <a th:href="@{/}">Home</a>
                <a th:href="@{/diet-plan/active}">Active Plan</a>
                <a th:href="@{/meal/today}">Today's Meals</a>
            </nav>
        </header>

        <main>
            <!-- Message when no diet plan exists -->
            <div th:if="${mealTypes == null || mealTypes.isEmpty()}" class="form-section" style="text-align: center; padding: 2rem;">
                <h2 style="color: #dc3545;">Diet Plan Not Found</h2>
                <p style="margin: 1rem 0;">You need to create a diet plan before recording meals.</p>
                <p style="margin: 1rem 0;">Please create a diet plan first to start tracking your meals.</p>
                <div style="margin-top: 2rem;">
                    <a th:href="@{/diet-plan/new}" class="btn btn-primary">Create Diet Plan</a>
                    <a th:href="@{/}" class="btn btn-secondary">Go to Home</a>
                </div>
            </div>

            <!-- Meal form (only shown when diet plan exists) -->
            <form th:if="${mealTypes != null && !mealTypes.isEmpty()}"
                  th:action="@{/meal}" th:object="${mealRecordRequest}" method="post" class="meal-form">
                <section class="form-section">
                    <h2>1. Select Meal Type</h2>

                    <div class="form-group">
                        <label for="mealTypeId">Meal Type *</label>
                        <select id="mealTypeId" th:field="*{mealTypeId}" required onchange="loadMealOptions()">
                            <option value="">-- Select --</option>
                            <option th:each="mealType : ${mealTypes}"
                                    th:value="${mealType.id}"
                                    th:text="${mealType.name} + ' (' + ${#temporals.format(mealType.scheduledTime, 'HH:mm')} + ')'">
                                Breakfast (06:20)
                            </option>
                        </select>
                    </div>
                </section>

                <section class="form-section">
                    <h2>2. Record Type</h2>

                    <div class="form-group">
                        <div class="radio-group">
                            <label>
                                <input type="radio" name="isFreeMeal" value="false"
                                       th:field="*{isFreeMeal}" checked
                                       onchange="toggleMealType(false)">
                                Planned Meal
                            </label>
                            <label>
                                <input type="radio" name="isFreeMeal" value="true"
                                       th:field="*{isFreeMeal}"
                                       onchange="toggleMealType(true)">
                                Free Meal
                            </label>
                        </div>
                    </div>
                </section>

                <!-- Section for Planned Meal -->
                <section class="form-section" id="planned-meal-section">
                    <h2>3. Choose Planned Option</h2>

                    <div class="form-group">
                        <label for="standardOptionId">Plan Option *</label>
                        <select id="standardOptionId" th:field="*{standardOptionId}">
                            <option value="">-- Select a meal type first --</option>
                            <!-- Options will be loaded dynamically via JavaScript -->
                        </select>
                    </div>
                </section>

                <!-- Section for Free Meal -->
                <section class="form-section" id="free-meal-section" style="display: none;">
                    <h2>3. Describe Free Meal</h2>

                    <div class="form-group">
                        <label for="freeMealDescription">Description *</label>
                        <textarea id="freeMealDescription" th:field="*{freeMealDescription}"
                                  rows="4" placeholder="Describe what you consumed..."></textarea>
                    </div>
                </section>

                <!-- Optional Fields (common to both types) -->
                <section class="form-section">
                    <h2>Additional Information (Optional)</h2>

                    <div class="form-row">
                        <div class="form-group">
                            <label for="quantity">Quantity</label>
                            <input type="number" id="quantity" th:field="*{quantity}"
                                   step="0.1" min="0" placeholder="1.0">
                        </div>
                        <div class="form-group">
                            <label for="unit">Unit</label>
                            <input type="text" id="unit" th:field="*{unit}"
                                   placeholder="serving, g, ml...">
                        </div>
                    </div>

                    <div class="form-group">
                        <label for="consumedAt">Consumption Time</label>
                        <input type="datetime-local" id="consumedAt" th:field="*{consumedAt}">
                    </div>

                    <div class="form-group">
                        <label for="notes">Notes</label>
                        <textarea id="notes" th:field="*{notes}" rows="3"
                                  placeholder="Additional notes about the meal..."></textarea>
                    </div>
                </section>

                <div class="form-actions">
                    <button type="submit" class="btn btn-primary">Record Meal</button>
                    <a th:href="@{/meal/today}" class="btn btn-secondary">Cancel</a>
                </div>
            </form>
        </main>

        <footer>
            <p>&copy; 2025 SanJy - Food Control System</p>
        </footer>
    </div>

    <script th:inline="javascript">
        /*<![CDATA[*/
        // Mock data - In production, this would come from backend
        const mealTypesData = /*[[${mealTypes}]]*/ [];

        function toggleMealType(isFreeMeal) {
            const plannedSection = document.getElementById('planned-meal-section');
            const freeSection = document.getElementById('free-meal-section');
            const standardOptionSelect = document.getElementById('standardOptionId');
            const freeMealTextarea = document.getElementById('freeMealDescription');

            if (isFreeMeal) {
                plannedSection.style.display = 'none';
                freeSection.style.display = 'block';
                standardOptionSelect.removeAttribute('required');
                freeMealTextarea.setAttribute('required', 'required');
            } else {
                plannedSection.style.display = 'block';
                freeSection.style.display = 'none';
                standardOptionSelect.setAttribute('required', 'required');
                freeMealTextarea.removeAttribute('required');
            }
        }

        function loadMealOptions() {
            const mealTypeId = document.getElementById('mealTypeId').value;
            const optionSelect = document.getElementById('standardOptionId');

            // Clear previous options
            optionSelect.innerHTML = '<option value="">-- Select an option --</option>';

            if (!mealTypeId) return;

            // Find the selected meal type and load its standard options
            const mealType = mealTypesData.find(mt => mt.id == mealTypeId);
            if (mealType && mealType.standardOptions) {
                mealType.standardOptions.forEach(option => {
                    const opt = document.createElement('option');
                    opt.value = option.id;
                    opt.textContent = `Option ${option.optionNumber} | ${option.description}`;
                    opt.dataset.description = option.description;
                    optionSelect.appendChild(opt);
                });
            }
        }

        // Set current datetime as default for consumption time
        function setDefaultConsumptionTime() {
            const consumedAtInput = document.getElementById('consumedAt');
            if (consumedAtInput && !consumedAtInput.value) {
                const now = new Date();
                // Format: YYYY-MM-DDTHH:MM
                const year = now.getFullYear();
                const month = String(now.getMonth() + 1).padStart(2, '0');
                const day = String(now.getDate()).padStart(2, '0');
                const hours = String(now.getHours()).padStart(2, '0');
                const minutes = String(now.getMinutes()).padStart(2, '0');
                consumedAtInput.value = `${year}-${month}-${day}T${hours}:${minutes}`;
            }
        }

        // Initialize correct state on page load
        document.addEventListener('DOMContentLoaded', function() {
            toggleMealType(false);
            setDefaultConsumptionTime();
        });
        /*]]>*/
    </script>
</body>
</html>
