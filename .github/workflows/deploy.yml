name: Deploy

on:
  push:
    branches:
      - main

jobs:
  quality-and-security:
    name: Code Quality and Security Analysis
    runs-on: ubuntu-latest

    permissions:
      contents: read

    steps:
      - name: Checkout code
        uses: actions/checkout@1af3b93b6815bc44a9784bd300feb67ff0d1eeb3 #v6.0.0

      - name: Setup Node.js 22
        uses: actions/setup-node@6044e13b5dc448c55e2357c09f80417699197238 #v6.2.0
        with:
          node-version: '22'
          cache: 'npm'
          cache-dependency-path: src/main/frontend/package-lock.json

      - name: Setup GraalVM 25 (Oracle)
        uses: graalvm/setup-graalvm@790e28947b79a9c09c3391c0f18bf8d0f102ed69 #v1.4.4
        with:
          java-version: '25'
          distribution: 'graalvm'
          github-token: ${{ secrets.GITHUB_TOKEN }}
          cache: 'maven'

      - name: Run tests to generate coverage report
        run: make test

      - name: Upload project to Snyk for monitoring
        env:
          SNYK_TOKEN: ${{ secrets.SNYK_TOKEN }}
        run: make snyk/monitor

      - name: Publish SonarCloud analysis
        env:
          SONAR_TOKEN: ${{ secrets.SONAR_TOKEN }}
        run: make sonar

  tag-and-release:
    name: Tag and Release
    runs-on: ubuntu-latest
    needs: quality-and-security

    permissions:
      contents: write

    steps:
      - name: Checkout code
        uses: actions/checkout@1af3b93b6815bc44a9784bd300feb67ff0d1eeb3 #v6.0.0

      - name: Setup Node.js 22
        uses: actions/setup-node@6044e13b5dc448c55e2357c09f80417699197238 #v6.2.0
        with:
          node-version: '22'
          cache: 'npm'
          cache-dependency-path: src/main/frontend/package-lock.json

      - name: Setup GraalVM 25 (Oracle)
        uses: graalvm/setup-graalvm@790e28947b79a9c09c3391c0f18bf8d0f102ed69 #v1.4.4
        with:
          java-version: '25'
          distribution: 'graalvm'
          github-token: ${{ secrets.GITHUB_TOKEN }}
          cache: 'maven'

      - name: Verify GraalVM installation
        run: |
          echo "GRAALVM_HOME: $GRAALVM_HOME"
          echo "JAVA_HOME: $JAVA_HOME"
          java -version
          node --version
          npm --version

      - name: Get current project version
        id: project-version
        run: |
          VERSION=$(make version)
          echo "version=$VERSION" >> $GITHUB_OUTPUT
          echo "Current project version: $VERSION"

      - name: Check if tag already exists
        id: check-tag
        run: |
          VERSION="${{ steps.project-version.outputs.version }}"

          if git ls-remote --tags origin | grep -q "refs/tags/$VERSION$"; then
            echo "::error::Tag $VERSION already exists in the repository!"
            echo ""
            echo "âŒ A release for version $VERSION has already been created."
            echo ""
            echo "ðŸ’¡ This should not happen if the pull request pipeline is working correctly."
            echo "   The version validation should have prevented this."
            echo ""
            echo "Possible causes:"
            echo "  1. The tag was created manually"
            echo "  2. A previous deploy workflow run already created this tag"
            echo "  3. The pull request pipeline was bypassed"
            exit 1
          fi

          echo "âœ… Tag $VERSION does not exist, proceeding with release"

      - name: Load environment variables
        run: |
          # Load .env file variables into GitHub environment
          if [ -f .env ]; then
            # Filter out comments and empty lines, then export to GITHUB_ENV
            grep -v '^#' .env | grep -v '^$' >> $GITHUB_ENV
          else
            echo "::error::.env file not found!"
            exit 1
          fi

      - name: Build frontend + GraalVM native image and JAR
        run: make build/graalvm

      - name: Find build artifacts
        id: artifacts
        run: |
          JAR_FILE=$(find target -name "*.jar" -type f | head -n 1)
          GRAAL_FILE=$(find target -name "*.graal" -type f | head -n 1)

          if [ -z "$JAR_FILE" ]; then
            echo "::error::JAR file not found in target/"
            exit 1
          fi

          if [ -z "$GRAAL_FILE" ]; then
            echo "::error::GraalVM binary (.graal) not found in target/"
            exit 1
          fi

          echo "jar_file=$JAR_FILE" >> $GITHUB_OUTPUT
          echo "graal_file=$GRAAL_FILE" >> $GITHUB_OUTPUT
          echo "Found JAR: $JAR_FILE"
          echo "Found GraalVM binary: $GRAAL_FILE"

      - name: Extract CHANGELOG for current version
        id: changelog
        run: |
          VERSION="${{ steps.project-version.outputs.version }}"
          CHANGELOG_FILE="CHANGELOG.md"

          # Extract the section for the current version
          # Get content between ## [VERSION] and the next ## (or end of file)
          CHANGELOG_CONTENT=$(sed -n "/^## \[$VERSION\]/,/^## \[/p" "$CHANGELOG_FILE" | sed '$d')

          # If it's the last version in the file, get everything until end
          if [ -z "$CHANGELOG_CONTENT" ]; then
            CHANGELOG_CONTENT=$(sed -n "/^## \[$VERSION\]/,\$p" "$CHANGELOG_FILE")
          fi

          # Remove the version header line (## [X.Y.Z] - DATE)
          CHANGELOG_CONTENT=$(echo "$CHANGELOG_CONTENT" | tail -n +2)

          # Save to file for multiline output
          echo "$CHANGELOG_CONTENT" > changelog_body.txt
          echo "âœ… Extracted CHANGELOG for version $VERSION"

      - name: Create Git tag
        run: |
          VERSION="${{ steps.project-version.outputs.version }}"

          git config user.name "github-actions[bot]"
          git config user.email "github-actions[bot]@users.noreply.github.com"

          git tag -a "$VERSION" -m "Release $VERSION"
          git push origin "$VERSION"

          echo "âœ… Created and pushed tag $VERSION"

      - name: Create GitHub Release
        uses: softprops/action-gh-release@a06a81a03ee405af7f2048a818ed3f03bbf83c7b #v2.5.0
        with:
          tag_name: ${{ steps.project-version.outputs.version }}
          name: ${{ steps.project-version.outputs.version }}
          body_path: changelog_body.txt
          files: |
            ${{ steps.artifacts.outputs.jar_file }}
            ${{ steps.artifacts.outputs.graal_file }}
          draft: false
          prerelease: false
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}

      - name: Upload build artifacts for Docker
        uses: actions/upload-artifact@b7c566a772e6b6bfb58ed0dc250532a479d7789f #v6.0.0
        with:
          name: build-artifacts
          path: |
            ${{ steps.artifacts.outputs.jar_file }}
            ${{ steps.artifacts.outputs.graal_file }}
          retention-days: 1

  deploy-image:
    name: Build and Push Docker Images
    runs-on: ubuntu-latest
    needs: tag-and-release

    steps:
      - name: Checkout code
        uses: actions/checkout@1af3b93b6815bc44a9784bd300feb67ff0d1eeb3 #v6.0.0

      - name: Setup GraalVM 25 (Oracle)
        uses: graalvm/setup-graalvm@790e28947b79a9c09c3391c0f18bf8d0f102ed69 #v1.4.4
        with:
          java-version: '25'
          distribution: 'graalvm'
          github-token: ${{ secrets.GITHUB_TOKEN }}
          cache: 'maven'

      - name: Get project version
        id: project-version
        run: |
          VERSION=$(make version)
          echo "version=$VERSION" >> $GITHUB_OUTPUT
          echo "Project version: $VERSION"

      - name: Download build artifacts
        uses: actions/download-artifact@018cc2cf5baa6db3ef3c5f8a56943fffe632ef53 #v6.0.0
        with:
          name: build-artifacts
          path: target/

      - name: Verify downloaded artifacts
        run: |
          echo "Downloaded artifacts:"
          ls -lh target/

          JAR_FILE=$(find target -name "*.jar" -type f | head -n 1)
          GRAAL_FILE=$(find target -name "*.graal" -type f | head -n 1)

          if [ -z "$JAR_FILE" ]; then
            echo "::error::JAR file not found!"
            exit 1
          fi

          if [ -z "$GRAAL_FILE" ]; then
            echo "::error::GraalVM binary not found!"
            exit 1
          fi

          echo "âœ… JAR file: $JAR_FILE"
          echo "âœ… GraalVM binary: $GRAAL_FILE"

      - name: Build JVM Docker image
        run: |
          echo "Building JVM Docker image..."
          make build/docker/local/jvm
          echo "âœ… JVM image built: under7/sanjy-client-web:${{ steps.project-version.outputs.version }}-jvm"

      - name: Build GraalVM Docker image
        run: |
          echo "Building GraalVM Docker image..."
          make build/docker/local/graalvm
          echo "âœ… GraalVM image built: under7/sanjy-client-web:${{ steps.project-version.outputs.version }}-graalvm"

      - name: Login to Docker Hub
        uses: docker/login-action@5e57cd118135c172c3672efd75eb46360885c0ef #v3.6.0
        with:
          username: ${{ secrets.DOCKERHUB_USERNAME }}
          password: ${{ secrets.DOCKERHUB_TOKEN }}

      - name: Push JVM image to Docker Hub
        run: |
          IMAGE_NAME="under7/sanjy-client-web:${{ steps.project-version.outputs.version }}-jvm"
          echo "Pushing $IMAGE_NAME..."
          docker push $IMAGE_NAME
          echo "âœ… JVM image pushed successfully"

      - name: Push GraalVM image to Docker Hub
        run: |
          IMAGE_NAME="under7/sanjy-client-web:${{ steps.project-version.outputs.version }}-graalvm"
          echo "Pushing $IMAGE_NAME..."
          docker push $IMAGE_NAME
          echo "âœ… GraalVM image pushed successfully"

      - name: Tag and push latest images
        run: |
          JVM_IMAGE="under7/sanjy-client-web:${{ steps.project-version.outputs.version }}-jvm"
          GRAALVM_IMAGE="under7/sanjy-client-web:${{ steps.project-version.outputs.version }}-graalvm"

          # Tag and push latest-jvm
          docker tag $JVM_IMAGE under7/sanjy-client-web:latest-jvm
          docker push under7/sanjy-client-web:latest-jvm
          echo "âœ… Tagged and pushed under7/sanjy-client-web:latest-jvm"

          # Tag and push latest-graalvm
          docker tag $GRAALVM_IMAGE under7/sanjy-client-web:latest-graalvm
          docker push under7/sanjy-client-web:latest-graalvm
          echo "âœ… Tagged and pushed under7/sanjy-client-web:latest-graalvm"

          # Tag and push latest (pointing to GraalVM)
          docker tag $GRAALVM_IMAGE under7/sanjy-client-web:latest
          docker push under7/sanjy-client-web:latest
          echo "âœ… Tagged and pushed under7/sanjy-client-web:latest"
